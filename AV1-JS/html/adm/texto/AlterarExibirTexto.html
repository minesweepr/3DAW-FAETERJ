<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Sistema Corporativo - Alterar E Exibir Uma Pergunta</title>
    <link rel="stylesheet" href="../../../css/geral.css"> 
    <link rel="stylesheet" href="../../../css/form.css"> 

    <script>
    function buscarPergunta(){
        let id=document.getElementById("idBusca").value;

        let msg=ValidaForm(id, -1);
        if(msg!==""){
            document.getElementById("msg").innerHTML=msg;
            return;
        }

        let xmlhttp=new XMLHttpRequest();
        console.log("1");
        xmlhttp.onreadystatechange=function(){
            if(this.readyState== 4 && this.status==200){
                try{
                    let objReturnJSON=JSON.parse(this.responseText);
                    if(objReturnJSON.erro){
                        document.getElementById("msg").innerHTML=objReturnJSON.erro;
                        document.getElementById("formAlterar").style.display="none";
                    }else{
                        document.getElementById("msg").innerHTML="";
                        document.getElementById("idp").value=objReturnJSON.id;
                        document.getElementById("pergunta").value=objReturnJSON.pergunta;
                        document.getElementById("formAlterar").dataset.idOriginal=objReturnJSON.id;
                        document.getElementById("formAlterar").style.display="block";
                    }
                }catch (e){
                    document.getElementById("msg").innerHTML="erro ao processar resposta";
                    document.getElementById("formAlterar").style.display="none";
                }
            }else if(this.readyState<4) {
                console.log("3: " + this.readyState);
            }else console.log("requisicao falhou: " + this.status);
        }
        console.log("4");

        xmlhttp.open("GET", "../../../php/adm/texto/listarUmTexto.php?id=" + id);
        xmlhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        xmlhttp.send();
    }

    function enviarAlteracao(){
        let idOriginal=document.getElementById("formAlterar").dataset.idOriginal;
        let idp=document.getElementById("idp").value;
        let pergunta=document.getElementById("pergunta").value;

        console.log("idOriginal: " + idOriginal + " idp: " + idp + " pergunta: " + pergunta);
        let msg=ValidaForm(idp, pergunta);
        if(msg!==""){
            document.getElementById("msg").innerHTML=msg;
            return;
        }

        let xmlhttp = new XMLHttpRequest();
        console.log("1");
        xmlhttp.onreadystatechange=function(){
            if (this.readyState==4 && this.status==200){
                console.log("Chegou a resposta OK: " + this.responseText);
                console.log("2");
                try {
                    let resposta=JSON.parse(this.responseText);
                    if(resposta.sucesso){
                        document.getElementById("msg").innerHTML = resposta.sucesso;
                        document.getElementById("formAlterar").style.display="none";
                        document.getElementById("idBusca").value="";
                    } else document.getElementById("msg").innerHTML=resposta.erro;
                }catch (e){ }
            }else if(this.readyState<4) {
                console.log("3: " + this.readyState);
            }else console.log("requisicao falhou: " + this.status);
        }
        console.log("4");

        xmlhttp.open("POST", "../../../php/adm/texto/alterarTexto.php");
        xmlhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        xmlhttp.send("id=" + encodeURIComponent(idOriginal) + "&idp=" + encodeURIComponent(idp) + "&pergunta=" + encodeURIComponent(pergunta));

        console.log("enviei form");
        console.log("5");
    }

    function ValidaForm(pId, pPergunta){
        let msg="";
        if(pId=="") msg="id nao preenchido<br>";
        if(pPergunta=="") msg+="pergunta nao preenchida<br>";
        return msg;
    }

    window.onload=function(){
        const parametros=new URLSearchParams(window.location.search);
        const id=parametros.get('id');
        if(id){
            document.getElementById('idBusca').value=id;
            buscarPergunta();
        }
    };
    </script>
</head>

<body>
    <nav>
        <ul>
          <li><a href="../../../php/adm/listarPerguntas.php">inicio</a></li>
        
          <li>
            <a href="#">discursivas ▼</a>
            <ul>
              <li><a href="../../../html/adm/texto/AlterarExibirTexto.html">alterar/exibir uma pergunta</a></li>
              <li><a href="../../../html/adm/texto/criarTexto.html">criar pergunta</a></li>
            </ul>
          </li>
      
          <li>
            <a href="#">multipla escolha ▼</a>
            <ul>
              <li><a href="../../../html/adm/multipla/AlterarExibirMultipla.html">alterar/exibir uma pergunta</a></li>
              <li><a href="../../../html/adm/multipla/criarMultipla.html">criar pergunta</a></li>
            </ul>
          </li>
      
          <li>
            <a href="#">usuários ▼</a>
            <ul>
              <li><a href="../../../php/adm/usuario/listarUsu.php">listar usuários</a></li>
              <li><a href="../../../php/adm/usuario/listarUmUsu.php">exibir um usuário</a></li>
              <li><a href="../../../html/adm/usuario/criarUsu.html">criar usuário</a></li>
            </ul>
          </li>
      
          <li class="sair"><a href="../../../index.php">sair</a></li>
        </ul>
    </nav>

<main>
    <h1>Alterar e Exibir Uma Pergunta Discursiva</h1>

    <form>
        <input type="number" id="idBusca" placeholder="id">
        <button class="btn" type="button" onclick="buscarPergunta()">Buscar</button>
    </form>

    <form id="formAlterar" style="display:none;">
        <label>id:
            <input type="number" id="idp" name="idp">
        </label>
        <label>pergunta:
            <input type="text" id="pergunta" name="pergunta">
        </label>
        <button class="btn" type="button" onclick="enviarAlteracao()">Salvar</button>
    </form>

    <p id="msg"></p>
</main>
</body>
</html>
